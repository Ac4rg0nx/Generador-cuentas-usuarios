<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cuentas de Usuario para Google</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluimos la librería SheetJS (xlsx) para generar archivos Excel/CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-bubble {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            font-weight: 700;
            color: white;
            background-color: #4f46e5; /* indigo-600 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        
        <div class="text-center mb-8">
            <svg class="mx-auto h-12 w-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962A3 3 0 013 10.5V12a3 3 0 01-3-3m11.962 4.354a9.094 9.094 0 01-3.741.479 3 3 0 01-4.682-2.72m7.5-2.962V7.5a3 3 0 00-3-3M3 10.5a3 3 0 013 3m9-9a3 3 0 00-3-3M3 7.5a3 3 0 013-3m9 9V12m-9-4.5a3 3 0 013-3" />
            </svg>
            <h1 class="text-3xl font-bold text-gray-900 mt-4">Generador de Cuentas para Google</h1>
            <p class="mt-2 text-md text-gray-600">Crea un CSV de importación evitando duplicados.</p>
        </div>

        <!-- PASO 1: Cargar base de datos existente -->
        <div class="mb-8">
            <div class="flex items-center mb-4">
                <div class="step-bubble">1</div>
                <h2 class="ml-4 text-xl font-semibold text-gray-800">Cargar Base de Datos Existente (Opcional)</h2>
            </div>
            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <label for="db-upload" class="cursor-pointer">
                    <svg class="mx-auto w-10 h-10 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600"><span class="font-semibold text-indigo-600">Selecciona un archivo Excel o CSV</span></p>
                    <p class="text-xs text-gray-500 mt-1">Con los usuarios ya existentes en tu sistema.</p>
                </label>
                <input id="db-upload" type="file" class="sr-only" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                <p id="db-status" class="mt-4 text-sm font-medium text-green-700"></p>
            </div>
        </div>

        <!-- PASO 2: Añadir nuevos usuarios -->
        <div class="mb-6">
            <div class="flex items-center mb-4">
                <div class="step-bubble">2</div>
                <h2 class="ml-4 text-xl font-semibold text-gray-800">Añadir Nuevos Nombres</h2>
            </div>
            <div id="file-upload-container" class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-6">
                <label for="file-upload" class="cursor-pointer">
                    <svg class="mx-auto w-10 h-10 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600"><span class="font-semibold text-indigo-600">Sube un archivo TXT/CSV</span> o arrástralo aquí.</p>
                </label>
                <input id="file-upload" type="file" class="sr-only" accept=".txt,.csv">
                <p id="file-name" class="mt-4 text-sm font-medium text-gray-700"></p>
            </div>
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-500 font-semibold">O</span><div class="flex-grow border-t border-gray-300"></div>
            </div>
            <div>
                 <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">Pega los nombres aquí (uno por línea):</label>
                 <textarea id="text-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Juan Pérez García&#10;José María López Hernández..."></textarea>
                 <button id="generate-button" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Generar desde Texto</button>
            </div>
        </div>

        <!-- PASO 3: Vista Previa y Descarga -->
         <div class="mt-8">
            <div class="flex items-center mb-4">
                <div class="step-bubble">3</div>
                <h2 class="ml-4 text-xl font-semibold text-gray-800">Vista Previa y Descarga</h2>
            </div>
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-4" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>
            
            <div id="notification-area" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 my-4" role="alert">
                <p class="font-bold">Aviso de Coincidencias</p>
                <p>Se detectaron correos que ya existían. Se generaron las siguientes alternativas:</p>
                <ul id="notification-list" class="list-disc list-inside mt-2 text-sm">
                </ul>
            </div>

            <div id="download-section" class="hidden text-center my-4">
                <button id="download-button" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Descargar Archivo CSV para Google</button>
            </div>
            <div id="preview-section" class="hidden mt-4">
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr id="preview-header"></tr></thead>
                        <tbody id="preview-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // UI Elements
        const dbUpload = document.getElementById('db-upload');
        const dbStatus = document.getElementById('db-status');
        const fileUpload = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const textInput = document.getElementById('text-input');
        const generateButton = document.getElementById('generate-button');
        const previewSection = document.getElementById('preview-section');
        const previewHeader = document.getElementById('preview-header');
        const previewTableBody = document.getElementById('preview-table-body');
        const downloadSection = document.getElementById('download-section');
        const downloadButton = document.getElementById('download-button');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const notificationArea = document.getElementById('notification-area');
        const notificationList = document.getElementById('notification-list');

        // Data Stores
        let processedData = [];
        let existingEmails = new Set();
        let duplicateNotifications = [];
        const EMAIL_DOMAIN = "@eccaonline.org";
        
        // --- Logic for loading and processing the existing database ---
        dbUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            dbStatus.textContent = "Procesando base de datos...";
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    if (json.length < 2) {
                        showError("El archivo de base de datos está vacío o no tiene cabeceras.");
                        dbStatus.textContent = "";
                        return;
                    }
                    
                    const headers = json[0];
                    const emailIndex = headers.findIndex(h => typeof h === 'string' && h.toLowerCase().includes('email address'));
                    
                    if (emailIndex === -1) {
                         showError('No se encontró la columna "Email Address [Required]" en el archivo de base de datos.');
                         dbStatus.textContent = "";
                         return;
                    }
                    
                    existingEmails.clear();
                    for (let i = 1; i < json.length; i++) {
                        const email = json[i][emailIndex];
                        if (email && typeof email === 'string') {
                            existingEmails.add(email.trim().toLowerCase());
                        }
                    }
                    dbStatus.textContent = `Base de datos cargada: ${existingEmails.size} usuarios existentes.`;
                    hideError();
                } catch (err) {
                     showError("Error al procesar el archivo de base de datos. Asegúrate de que es un Excel o CSV válido.");
                     dbStatus.textContent = "";
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- Logic for processing new names ---
        const capitalize = (s) => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
        const normalizeString = (s) => s ? s.normalize("NFD").replace(/[\u0300-\u036f]/g, "") : '';

        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                resetGenerationUI();
                fileNameDisplay.textContent = `Archivo: ${file.name}`;
                const reader = new FileReader();
                reader.onload = (e) => processText(e.target.result);
                reader.readAsText(file);
            }
        });
        
        generateButton.addEventListener('click', () => {
             const content = textInput.value;
             if (content.trim() === '') {
                 showError("El cuadro de texto está vacío.");
                 return;
             }
             resetGenerationUI();
             processText(content);
        });

        const processText = (content) => {
            const lines = content.split(/\r\n|\n/).filter(line => line.trim() !== '');
            const commonSecondNames = new Set(['MARIA', 'JOSE', 'JESUS', 'ANTONIO', 'MANUEL', 'FRANCISCO', 'JUAN', 'LUIS', 'ANGEL', 'MIGUEL', 'CARLOS', 'JAVIER']);
            
            if (lines.length === 0) {
                showError("No se encontraron nombres válidos.");
                return;
            }

            // ** FASE 1: Parsear nombres y crear lista preliminar **
            let preliminaryUsers = [];
            lines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                if (parts.length < 2) return;

                let namePartsCount = 1;
                if (parts.length >= 4) namePartsCount = 2;
                else if (parts.length === 3 && commonSecondNames.has(normalizeString(parts[1]).toUpperCase())) namePartsCount = 2;

                const nombre = parts.slice(0, namePartsCount).map(capitalize).join(' ');
                const nombreParts = nombre.split(' ');

                const apellidos = parts.slice(namePartsCount).map(capitalize).join(' '); 
                const primerApellido = parts[namePartsCount];
                
                if (!primerApellido) return;

                const segundoApellido = parts.length > namePartsCount + 1 ? parts[namePartsCount + 1] : null;

                // --- NUEVA LÓGICA PARA INICIALES ---
                let emailInitials;
                if (nombreParts.length > 1) {
                    // Nombre compuesto: tomar todas las iniciales (ej: jl)
                    emailInitials = normalizeString(nombreParts.map(n => n.charAt(0)).join(''));
                } else {
                    // Nombre simple: tomar una inicial (ej: j)
                    emailInitials = normalizeString(nombre.charAt(0));
                }

                const firstSurname = normalizeString(primerApellido);
                const preliminaryEmail = `${emailInitials}.${firstSurname}${EMAIL_DOMAIN}`.toLowerCase();
                
                preliminaryUsers.push({ nombre, apellidos, primerApellido, segundoApellido, preliminaryEmail, emailInitials });
            });

            // ** FASE 2: Verificar duplicados y generar lista final **
            const generatedEmailsInBatch = new Set();
            processedData = []; // Reset final data

            preliminaryUsers.forEach(user => {
                let emailAttempt = user.preliminaryEmail;
                let finalEmail = '';
                let counter = 0;
                let wasCollision = false;

                while(true) {
                    if (!existingEmails.has(emailAttempt) && !generatedEmailsInBatch.has(emailAttempt)) {
                        finalEmail = emailAttempt;
                        break;
                    }
                    
                    wasCollision = true;
                    counter++;
                    
                    const firstSurname = normalizeString(user.primerApellido);

                    if(counter === 1 && user.segundoApellido) {
                        const secondInitial = normalizeString(user.segundoApellido.charAt(0));
                        emailAttempt = `${user.emailInitials}.${firstSurname}${secondInitial}${EMAIL_DOMAIN}`.toLowerCase();
                    } else {
                        const effectiveCounter = counter === 1 ? 2 : counter;
                        emailAttempt = `${user.emailInitials}.${firstSurname}${effectiveCounter}${EMAIL_DOMAIN}`.toLowerCase();
                    }
                }
                
                if (wasCollision) {
                    duplicateNotifications.push(`<b>${user.nombre} ${user.apellidos}:</b> Se generó el correo alternativo <b>${finalEmail}</b>`);
                }

                generatedEmailsInBatch.add(finalEmail);

                processedData.push({
                    "First Name [Required]": user.nombre,
                    "Last Name [Required]": user.apellidos,
                    "Email Address [Required]": finalEmail,
                    "Password [Required]": "Ecca2526",
                    "Org Unit Path [Required]": "/Alumnado",
                    "Change Password at Next Sign-In": "TRUE"
                });
            });
            
            if (processedData.length > 0) {
                displayPreview();
            } else {
                showError("No se pudieron procesar nombres. Asegúrate de que el formato sea 'Nombre Apellido(s)' por línea.");
            }
        };

        const displayPreview = () => {
            previewHeader.innerHTML = '';
            previewTableBody.innerHTML = '';
            
            ["Nombre", "Apellidos", "Email Generado", "Unidad Org."].forEach(text => {
                const th = document.createElement('th');
                th.className = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
                th.textContent = text;
                previewHeader.appendChild(th);
            });
            
            processedData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item["First Name [Required]"]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item["Last Name [Required]"]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item["Email Address [Required]"]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item["Org Unit Path [Required]"]}</td>
                `;
                previewTableBody.appendChild(row);
            });

            if (duplicateNotifications.length > 0) {
                notificationList.innerHTML = '';
                duplicateNotifications.forEach(msg => {
                    const li = document.createElement('li');
                    li.innerHTML = msg;
                    notificationList.appendChild(li);
                });
                notificationArea.classList.remove('hidden');
            }

            previewSection.classList.remove('hidden');
            downloadSection.classList.remove('hidden');
        };

        downloadButton.addEventListener('click', () => {
            const allGoogleHeaders = ["First Name [Required]", "Last Name [Required]", "Email Address [Required]", "Password [Required]", "Password Hash Function [UPLOAD ONLY]", "Org Unit Path [Required]", "New Primary Email [UPLOAD ONLY]", "Recovery Email", "Home Secondary Email", "Work Secondary Email", "Recovery Phone [MUST BE IN THE E.164 FORMAT]", "Work Phone", "Home Phone", "Mobile Phone", "Work Address", "Home Address", "Employee ID", "Employee Type", "Employee Title", "Manager Email", "Department", "Cost Center", "Building ID", "Floor Name", "Floor Section", "Change Password at Next Sign-In", "New Status [UPLOAD ONLY]", "New Licenses [UPLOAD ONLY]", "Advanced Protection Program enrollment"];
            
            const fullDataForCsv = processedData.map(user => {
               const fullUser = {};
               allGoogleHeaders.forEach(header => {
                   fullUser[header] = user[header] || "";
               });
               return fullUser;
            });

            const worksheet = XLSX.utils.json_to_sheet(fullDataForCsv, { header: allGoogleHeaders });
            const csvOutput = XLSX.utils.sheet_to_csv(worksheet);
            const blob = new Blob([csvOutput], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "usuarios_para_google.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // UI Utility Functions
        const showError = (message) => { errorText.textContent = message; errorMessage.classList.remove('hidden'); };
        const hideError = () => errorMessage.classList.add('hidden');
        const resetGenerationUI = () => {
            processedData = [];
            duplicateNotifications = [];
            notificationArea.classList.add('hidden');
            notificationList.innerHTML = '';
            previewSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
            hideError();
            previewTableBody.innerHTML = '';
            fileNameDisplay.textContent = '';
        };

    </script>
</body>
</html>

